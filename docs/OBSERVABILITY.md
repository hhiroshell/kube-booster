# kube-booster Observability Guide

This guide covers monitoring and observability features for kube-booster, including Prometheus metrics, alerting, and Grafana dashboards.

## Prometheus Metrics

kube-booster exports Prometheus metrics on the controller's metrics endpoint (default `:8080/metrics`). These metrics provide visibility into warmup execution performance and outcomes.

### Available Metrics

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `kube_booster_warmup_total` | Counter | `namespace`, `result` | Total warmup executions (result: success/failure) |
| `kube_booster_warmup_requests_total` | Counter | `namespace` | Total HTTP requests sent during warmup |
| `kube_booster_warmup_duration_seconds` | Histogram | `namespace` | Time from warmup start to completion |
| `kube_booster_warmup_request_latency_seconds` | Histogram | `namespace` | Individual request latency during warmup |
| `kube_booster_pods_pending_warmup` | Gauge | `namespace`, `node` | Pods currently waiting for warmup |

### Metric Details

#### kube_booster_warmup_total

A counter that tracks the total number of warmup executions. Labeled by:
- `namespace`: The Kubernetes namespace of the pod
- `result`: Either "success" or "failure"

Use this metric to calculate warmup success rates and track failure trends.

#### kube_booster_warmup_requests_total

A counter tracking the total number of HTTP requests sent to pods during warmup. This represents the aggregate load generated by the warmup process.

#### kube_booster_warmup_duration_seconds

A histogram tracking the total duration of warmup executions. Uses default Prometheus buckets:
`.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10` seconds.

This metric helps identify slow warmups that may delay pod readiness.

#### kube_booster_warmup_request_latency_seconds

A histogram tracking individual request latencies observed during warmup. Uses custom buckets optimized for HTTP latencies:
`.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10` seconds.

Records P50 and P99 latencies from Vegeta results for each warmup execution.

#### kube_booster_pods_pending_warmup

A gauge showing the current number of pods waiting for warmup completion. Useful for capacity planning and identifying warmup bottlenecks.

## Prometheus Configuration

### Scrape Configuration

Add the following to your Prometheus configuration to scrape kube-booster metrics:

```yaml
scrape_configs:
  - job_name: 'kube-booster'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      # Keep only kube-booster pods
      - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
        regex: kube-booster
        action: keep
      # Keep only the metrics port
      - source_labels: [__meta_kubernetes_pod_container_port_number]
        regex: "8080"
        action: keep
      # Use pod name as instance
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: instance
      # Add namespace label
      - source_labels: [__meta_kubernetes_namespace]
        target_label: kubernetes_namespace
```

### ServiceMonitor (for Prometheus Operator)

If using the Prometheus Operator, create a ServiceMonitor:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kube-booster
  namespace: kube-system
  labels:
    app.kubernetes.io/name: kube-booster
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: kube-booster
  namespaceSelector:
    matchNames:
      - kube-system
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
```

## Example PromQL Queries

### Warmup Success Rate

Calculate the warmup success rate over the last 5 minutes:

```promql
# Overall success rate
sum(rate(kube_booster_warmup_total{result="success"}[5m]))
/
sum(rate(kube_booster_warmup_total[5m]))

# Success rate by namespace
sum(rate(kube_booster_warmup_total{result="success"}[5m])) by (namespace)
/
sum(rate(kube_booster_warmup_total[5m])) by (namespace)
```

### Warmup Duration Percentiles

Calculate warmup duration percentiles:

```promql
# P95 warmup duration across all namespaces
histogram_quantile(0.95, sum(rate(kube_booster_warmup_duration_seconds_bucket[5m])) by (le))

# P95 warmup duration by namespace
histogram_quantile(0.95, sum(rate(kube_booster_warmup_duration_seconds_bucket[5m])) by (le, namespace))

# P50 (median) warmup duration
histogram_quantile(0.50, sum(rate(kube_booster_warmup_duration_seconds_bucket[5m])) by (le))
```

### Request Latency Analysis

```promql
# P99 request latency
histogram_quantile(0.99, sum(rate(kube_booster_warmup_request_latency_seconds_bucket[5m])) by (le))

# P50 request latency by namespace
histogram_quantile(0.50, sum(rate(kube_booster_warmup_request_latency_seconds_bucket[5m])) by (le, namespace))
```

### Pending Pods

```promql
# Total pending pods across all namespaces
sum(kube_booster_pods_pending_warmup)

# Pending pods by namespace
sum(kube_booster_pods_pending_warmup) by (namespace)

# Pending pods by node
sum(kube_booster_pods_pending_warmup) by (node)
```

### Warmup Throughput

```promql
# Warmups per minute
sum(rate(kube_booster_warmup_total[5m])) * 60

# HTTP requests per minute generated by warmup
sum(rate(kube_booster_warmup_requests_total[5m])) * 60
```

## Alerting Rules

Example Prometheus alerting rules for kube-booster:

```yaml
groups:
  - name: kube-booster
    rules:
      # Alert on high warmup failure rate
      - alert: KubeBoosterHighWarmupFailureRate
        expr: |
          (
            sum(rate(kube_booster_warmup_total{result="failure"}[5m]))
            /
            sum(rate(kube_booster_warmup_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High warmup failure rate"
          description: "More than 10% of warmups are failing in the last 5 minutes"

      # Alert on slow warmups
      - alert: KubeBoosterSlowWarmup
        expr: |
          histogram_quantile(0.95, sum(rate(kube_booster_warmup_duration_seconds_bucket[5m])) by (le))
          > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow warmup executions"
          description: "P95 warmup duration is over 60 seconds"

      # Alert on warmup backlog
      - alert: KubeBoosterWarmupBacklog
        expr: sum(kube_booster_pods_pending_warmup) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Warmup backlog building up"
          description: "More than 10 pods are pending warmup"

      # Alert on high request latency
      - alert: KubeBoosterHighRequestLatency
        expr: |
          histogram_quantile(0.99, sum(rate(kube_booster_warmup_request_latency_seconds_bucket[5m])) by (le))
          > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High warmup request latency"
          description: "P99 request latency is over 5 seconds"
```

## Grafana Dashboard

A sample Grafana dashboard is provided at `config/samples/grafana-dashboard.json`. Import this dashboard to visualize:

- Warmup success/failure rate over time
- Warmup duration histogram and percentiles
- Request latency percentiles
- Pending pods by namespace and node
- Warmup throughput

### Dashboard Panels

1. **Warmup Success Rate**: Shows the percentage of successful warmups over time
2. **Warmup Failures**: Displays failure count with namespace breakdown
3. **Warmup Duration (P50/P95/P99)**: Tracks warmup latency trends
4. **Request Latency (P50/P99)**: Shows individual request latencies
5. **Pods Pending Warmup**: Real-time gauge of pods waiting for warmup
6. **Warmup Throughput**: Rate of warmup completions per minute

## Kubernetes Events

In addition to Prometheus metrics, kube-booster emits Kubernetes Events for warmup lifecycle visibility:

| Event | Type | Description |
|-------|------|-------------|
| `WarmupStarted` | Normal | Warmup execution begins |
| `WarmupCompleted` | Normal | Warmup completed successfully |
| `WarmupFailed` | Warning | Warmup failed (config error or request failures) |
| `ConditionUpdated` | Normal/Warning | Pod condition set to True (Warning if fail-open) |

View events with:

```bash
kubectl describe pod <pod-name> | grep -A 20 Events
```

Or query events directly:

```bash
kubectl get events --field-selector reason=WarmupCompleted
kubectl get events --field-selector reason=WarmupFailed
```

## Best Practices

### Cardinality Management

The metrics use namespace-level labels to avoid high cardinality issues:
- Pod names are NOT included in counter/histogram labels
- Node names are only used in the gauge metric (bounded by cluster size)

### Retention Recommendations

- Keep at least 7 days of data for trend analysis
- Use recording rules for frequently-queried aggregations

### Dashboard Organization

Consider organizing dashboards by:
1. **Overview**: Cluster-wide warmup health
2. **By Namespace**: Drill down into specific namespaces
3. **By Application**: Filter by labels for app-specific views

## Troubleshooting

### Metrics Not Appearing

1. Verify the controller is running:
   ```bash
   kubectl get pods -n kube-system -l app.kubernetes.io/component=controller
   ```

2. Check metrics endpoint directly:
   ```bash
   kubectl port-forward -n kube-system deploy/kube-booster-controller 8080:8080
   curl localhost:8080/metrics | grep kube_booster
   ```

3. Verify Prometheus scrape configuration and targets

### Unexpected Metric Values

1. Check pod events for context:
   ```bash
   kubectl describe pod <pod-name>
   ```

2. Review controller logs:
   ```bash
   kubectl logs -n kube-system -l app.kubernetes.io/component=controller
   ```

## Related Documentation

- [USAGE.md](USAGE.md) - General usage and configuration
- [DEVELOPMENT.md](DEVELOPMENT.md) - Development guide
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) - Technical implementation details
